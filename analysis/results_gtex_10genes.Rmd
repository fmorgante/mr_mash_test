---
title: "mr.mash vs mtlasso vs UTMOST"
author: "Fabio Morgante"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r set opts, message=FALSE}
###Set options
options(stringsAsFactors=FALSE)

###Load libraries
library(cowplot)
library(ggplot2)

###Function to compute accuracy
compute_accuracy <- function(Y, Yhat) {
  bias <- rep(as.numeric(NA), ncol(Y))
  names(bias) <- colnames(Y)
  r2 <- rep(as.numeric(NA), ncol(Y))
  names(r2) <- colnames(Y)
  scaled_rmse <- rep(as.numeric(NA), ncol(Y))
  names(scaled_rmse) <- colnames(Y)
  
  for(i in 1:ncol(Y)){ 
    dat <- na.omit(data.frame(Y[, i], Yhat[, i]))
    colnames(dat) <- c("Y", "Yhat")
    
    fit  <- lm(Y ~ Yhat, data=dat)
    bias[i] <- coef(fit)[2] 
    r2[i] <- summary(fit)$r.squared
    scaled_rmse[i] <- sqrt(mean((dat$Y - dat$Yhat)^2))/sd(dat$Y)
  }
  
  return(list(bias=bias, r2=r2, scaled_rmse=scaled_rmse))
}

###Genes to be analyzed
genes <- c("ENSG00000083812.11", "ENSG00000156413.13", "ENSG00000171119.2",
           "ENSG00000198131.13", "ENSG00000214626.2", "ENSG00000268201.1",
	   "ENSG00000268866.1", "ENSG00000269794.1", "ENSG00000269855.2",
	   "ENSG00000273901.1")

###Set some parameters
thresh <- 100
```

In all the analyses so far, we have used [Abhishek's implementation of the sparse multi-task LASSO](https://users.rcc.uchicago.edu/~aksarkar/gtex-pred/lasso.html) (called mtlasso here), the method that was used in [UTMOST](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6788740/). This is because the [original implementation](https://github.com/yiminghu/CTIMP) requires the data in an awkward format. Note that Abhishek's implementation is not exactly the same as UTMOST. For example, the initialization of the coefficients and the way to choose the grid of values for the tuning parameters are different. Recently, the Ritchie Lab reimplemented the [method](https://github.com/RitchieLab/multi_tissue_twas_sim) using the original code from the UTMOST autors so that it takes in data in the standard format (i.e., Y in matrix form). The caveat is that this reimplementation does not allow for missing values in Y. In this website, we want to compare *mr.mash* to both the Ritchie Lab's implementation and Abhishek's implementation of UTMOST. 

```{r process results}
p_mrmash_sec <- vector("list", length(genes))
p_enet <- vector("list", length(genes))
p_mtlasso <- vector("list", length(genes))

t <- 0

for(gene in genes){

    t <- t+1

    ###Load the data
    dat1_first <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_1/", gene, ".GTEx_V8_fold_1_batch_1_mrmash.first_pass.rds"))
    dat2_first <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_2/", gene, ".GTEx_V8_fold_2_batch_1_mrmash.first_pass.rds"))
    dat3_first <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_3/", gene, ".GTEx_V8_fold_3_batch_1_mrmash.first_pass.rds"))
    dat4_first <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_4/", gene, ".GTEx_V8_fold_4_batch_1_mrmash.first_pass.rds"))
    dat5_first <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_5/", gene, ".GTEx_V8_fold_5_batch_1_mrmash.first_pass.rds"))

    dat1_sec <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_1/", gene, ".GTEx_V8_fold_1_batch_1_mrmash.second_pass.rds"))
    dat2_sec <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_2/", gene, ".GTEx_V8_fold_2_batch_1_mrmash.second_pass.rds"))
    dat3_sec <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_3/", gene, ".GTEx_V8_fold_3_batch_1_mrmash.second_pass.rds"))
    dat4_sec <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_4/", gene, ".GTEx_V8_fold_4_batch_1_mrmash.second_pass.rds"))
    dat5_sec <- readRDS(paste0("output/gtex_mr_mash_analysis/prediction/fold_5/", gene, ".GTEx_V8_fold_5_batch_1_mrmash.second_pass.rds"))

    dat1_mtlasso <- readRDS(paste0("output/gtex_mr_mash_analysis/mtlasso/fold_1/", gene, ".GTEx_V8_fold_1_mtlasso.rds"))
    dat2_mtlasso <- readRDS(paste0("output/gtex_mr_mash_analysis/mtlasso/fold_2/", gene, ".GTEx_V8_fold_2_mtlasso.rds"))
    dat3_mtlasso <- readRDS(paste0("output/gtex_mr_mash_analysis/mtlasso/fold_3/", gene, ".GTEx_V8_fold_3_mtlasso.rds"))
    dat4_mtlasso <- readRDS(paste0("output/gtex_mr_mash_analysis/mtlasso/fold_4/", gene, ".GTEx_V8_fold_4_mtlasso.rds"))
    dat5_mtlasso <- readRDS(paste0("output/gtex_mr_mash_analysis/mtlasso/fold_5/", gene, ".GTEx_V8_fold_5_mtlasso.rds"))


    dat_input <- readRDS(paste0("data/cis_eqtl_analysis_ready/", gene, ".GTEx_V8.rds"))

    sample_size <- apply(dat_input$y_res, 2, function(x){sum(!is.na(x))})
    sample_size <- data.frame(tissue=names(sample_size), sample_size)

    ###enet accuracy
    acc_enet1 <- compute_accuracy(dat1_first$Ytest, dat1_first$Yhat_test_glmnet)
    r2_enet1 <- acc_enet1$r2
    scaled_rmse_enet1 <- acc_enet1$scaled_rmse

    acc_enet2 <- compute_accuracy(dat2_first$Ytest, dat2_first$Yhat_test_glmnet)
    r2_enet2 <- acc_enet2$r2
    scaled_rmse_enet2 <- acc_enet2$scaled_rmse

    acc_enet3 <- compute_accuracy(dat3_first$Ytest, dat3_first$Yhat_test_glmnet)
    r2_enet3 <- acc_enet3$r2
    scaled_rmse_enet3 <- acc_enet3$scaled_rmse

    acc_enet4 <- compute_accuracy(dat4_first$Ytest, dat4_first$Yhat_test_glmnet)
    r2_enet4 <- acc_enet4$r2
    scaled_rmse_enet4 <- acc_enet4$scaled_rmse

    acc_enet5 <- compute_accuracy(dat5_first$Ytest, dat5_first$Yhat_test_glmnet)
    r2_enet5 <- acc_enet5$r2
    scaled_rmse_enet5 <- acc_enet5$scaled_rmse

    r2_enet <- cbind(r2_enet1, r2_enet2, r2_enet3, r2_enet4, r2_enet5)
    scaled_rmse_enet <- cbind(scaled_rmse_enet1, scaled_rmse_enet2, scaled_rmse_enet3, scaled_rmse_enet4, scaled_rmse_enet5)

    ###mr.mash first pass accuracy
    acc_mrmash1 <- compute_accuracy(dat1_first$Ytest, dat1_first$Yhat_test)
    r2_mrmash1 <- acc_mrmash1$r2
    scaled_rmse_mrmash1 <- acc_mrmash1$scaled_rmse

    acc_mrmash2 <- compute_accuracy(dat2_first$Ytest, dat2_first$Yhat_test)
    r2_mrmash2 <- acc_mrmash2$r2
    scaled_rmse_mrmash2 <- acc_mrmash2$scaled_rmse

    acc_mrmash3 <- compute_accuracy(dat3_first$Ytest, dat3_first$Yhat_test)
    r2_mrmash3 <- acc_mrmash3$r2
    scaled_rmse_mrmash3 <- acc_mrmash3$scaled_rmse

    acc_mrmash4 <- compute_accuracy(dat4_first$Ytest, dat4_first$Yhat_test)
    r2_mrmash4 <- acc_mrmash4$r2
    scaled_rmse_mrmash4 <- acc_mrmash4$scaled_rmse

    acc_mrmash5 <- compute_accuracy(dat5_first$Ytest, dat5_first$Yhat_test)
    r2_mrmash5 <- acc_mrmash5$r2
    scaled_rmse_mrmash5 <- acc_mrmash5$scaled_rmse

    r2_mrmash_first <- cbind(r2_mrmash1, r2_mrmash2, r2_mrmash3, r2_mrmash4, r2_mrmash5)
    scaled_rmse_mrmash_first <- cbind(scaled_rmse_mrmash1, scaled_rmse_mrmash2, scaled_rmse_mrmash3, scaled_rmse_mrmash4, scaled_rmse_mrmash5)

    ###mr.mash second pass accuracy
    acc_mrmash1 <- compute_accuracy(dat1_sec$Ytest, dat1_sec$Yhat_test)
    r2_mrmash1 <- acc_mrmash1$r2
    scaled_rmse_mrmash1 <- acc_mrmash1$scaled_rmse

    acc_mrmash2 <- compute_accuracy(dat2_sec$Ytest, dat2_sec$Yhat_test)
    r2_mrmash2 <- acc_mrmash2$r2
    scaled_rmse_mrmash2 <- acc_mrmash2$scaled_rmse

    acc_mrmash3 <- compute_accuracy(dat3_sec$Ytest, dat3_sec$Yhat_test)
    r2_mrmash3 <- acc_mrmash3$r2
    scaled_rmse_mrmash3 <- acc_mrmash3$scaled_rmse

    acc_mrmash4 <- compute_accuracy(dat4_sec$Ytest, dat4_sec$Yhat_test)
    r2_mrmash4 <- acc_mrmash4$r2
    scaled_rmse_mrmash4 <- acc_mrmash4$scaled_rmse

    acc_mrmash5 <- compute_accuracy(dat5_sec$Ytest, dat5_sec$Yhat_test)
    r2_mrmash5 <- acc_mrmash5$r2
    scaled_rmse_mrmash5 <- acc_mrmash5$scaled_rmse

    r2_mrmash_sec <- cbind(r2_mrmash1, r2_mrmash2, r2_mrmash3, r2_mrmash4, r2_mrmash5)
    scaled_rmse_mrmash_sec <- cbind(scaled_rmse_mrmash1, scaled_rmse_mrmash2, scaled_rmse_mrmash3, scaled_rmse_mrmash4, scaled_rmse_mrmash5)

    ###mtlasso accuracy
    acc_mtlasso1 <- compute_accuracy(dat1_mtlasso$Ytest, dat1_mtlasso$Yhat_test)
    r2_mtlasso1 <- acc_mtlasso1$r2
    scaled_rmse_mtlasso1 <- acc_mtlasso1$scaled_rmse

    acc_mtlasso2 <- compute_accuracy(dat2_mtlasso$Ytest, dat2_mtlasso$Yhat_test)
    r2_mtlasso2 <- acc_mtlasso2$r2
    scaled_rmse_mtlasso2 <- acc_mtlasso2$scaled_rmse

    acc_mtlasso3 <- compute_accuracy(dat3_mtlasso$Ytest, dat3_mtlasso$Yhat_test)
    r2_mtlasso3 <- acc_mtlasso3$r2
    scaled_rmse_mtlasso3 <- acc_mtlasso3$scaled_rmse

    acc_mtlasso4 <- compute_accuracy(dat4_mtlasso$Ytest, dat4_mtlasso$Yhat_test)
    r2_mtlasso4 <- acc_mtlasso4$r2
    scaled_rmse_mtlasso4 <- acc_mtlasso4$scaled_rmse

    acc_mtlasso5 <- compute_accuracy(dat5_mtlasso$Ytest, dat5_mtlasso$Yhat_test)
    r2_mtlasso5 <- acc_mtlasso5$r2
    scaled_rmse_mtlasso5 <- acc_mtlasso5$scaled_rmse

    r2_mtlasso <- cbind(r2_mtlasso1, r2_mtlasso2, r2_mtlasso3, r2_mtlasso4, r2_mtlasso5)
    scaled_rmse_mtlasso <- cbind(scaled_rmse_mtlasso1, scaled_rmse_mtlasso2, scaled_rmse_mtlasso3, scaled_rmse_mtlasso4, scaled_rmse_mtlasso5)

    ###Combined accuracy

    mean_r2 <- cbind(enet=rowMeans(r2_enet, na.rm=TRUE), mrmash_first=rowMeans(r2_mrmash_first, na.rm=TRUE), 
                     mrmash_sec=rowMeans(r2_mrmash_sec, na.rm=TRUE), mtlasso=rowMeans(r2_mtlasso, na.rm=TRUE))
    se_r2 <- cbind(enet=matrixStats::rowSds(r2_enet, na.rm=TRUE)/apply(r2_enet, 1, function(x){sum(is.finite(x))}), 
                    mrmash_first=matrixStats::rowSds(r2_mrmash_first, na.rm=TRUE)/apply(r2_mrmash_first, 1, function(x){sum(is.finite(x))}),
                    mrmash_sec=matrixStats::rowSds(r2_mrmash_sec, na.rm=TRUE)/apply(r2_mrmash_sec, 1, function(x){sum(is.finite(x))}),
                    mtlasso=matrixStats::rowSds(r2_mtlasso, na.rm=TRUE)/apply(r2_mtlasso, 1, function(x){sum(is.finite(x))}))
                    
    mean_scaled_rmse <- cbind(enet=rowMeans(scaled_rmse_enet, na.rm=TRUE), mrmash_first=rowMeans(scaled_rmse_mrmash_first, na.rm=TRUE), 
                              mrmash_sec=rowMeans(scaled_rmse_mrmash_sec, na.rm=TRUE), mtlasso=rowMeans(scaled_rmse_mtlasso, na.rm=TRUE))
    se_scaled_rmse <- cbind(enet=matrixStats::rowSds(scaled_rmse_enet, na.rm=TRUE)/apply(scaled_rmse_enet, 1, function(x){sum(is.finite(x))}), 
                            mrmash_first=matrixStats::rowSds(scaled_rmse_mrmash_first, na.rm=TRUE)/apply(scaled_rmse_mrmash_first, 1, function(x){sum(is.finite(x))}),
                            mrmash_sec=matrixStats::rowSds(scaled_rmse_mrmash_sec, na.rm=TRUE)/apply(scaled_rmse_mrmash_sec, 1, function(x){sum(is.finite(x))}),
                            mtlasso=matrixStats::rowSds(scaled_rmse_mtlasso, na.rm=TRUE)/apply(scaled_rmse_mtlasso, 1, function(x){sum(is.finite(x))}))
    
    ###Plots
    min_lim <- min(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "mrmash_sec"]))
    max_lim <- max(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "mrmash_sec"]))
    p_mrmash_sec[[t]] <- ggplot(as.data.frame(mean_scaled_rmse), aes(x=mrmash_sec, y=mrmash_first)) + geom_point(shape=1) + xlim(min_lim, max_lim) + ylim(min_lim, max_lim) +
                                labs(x = "mr.mash (second)", y = "mr.mash (first)", title=paste0(gene, "\nRMSE")) + geom_abline(intercept = 0, slope = 1) + theme_cowplot() +
                                theme(plot.title = element_text(hjust = 0.5))    

    min_lim <- min(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "enet"]))
    max_lim <- max(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "enet"]))
    p_enet[[t]] <- ggplot(as.data.frame(mean_scaled_rmse), aes(x=enet, y=mrmash_first)) + geom_point(shape=1) + xlim(min_lim, max_lim) + ylim(min_lim, max_lim) +
                    labs(x = "e-net", y = "mr.mash", title=paste0(gene, "\nRMSE")) + geom_abline(intercept = 0, slope = 1) + theme_cowplot() +
                    theme(plot.title = element_text(hjust = 0.5))    

    min_lim <- min(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "mtlasso"]))
    max_lim <- max(c(mean_scaled_rmse[, "mrmash_first"], mean_scaled_rmse[, "mtlasso"]))
    p_mtlasso[[t]] <- ggplot(as.data.frame(mean_scaled_rmse), aes(x=mtlasso, y=mrmash_first)) + geom_point(shape=1) + xlim(min_lim, max_lim) + ylim(min_lim, max_lim) +
                        labs(x = "smt-lasso", y = "mr.mash", title=paste0(gene, "\nRMSE")) + geom_abline(intercept = 0, slope = 1) + theme_cowplot() +
                        theme(plot.title = element_text(hjust = 0.5))    
}
```

### *mr.mash* first pass vs second pass

```{r mr.mash first vs second pass, message=FALSE, fig.height=15, fig.width=15}
plot_grid(p_mrmash_sec[[1]], p_mrmash_sec[[2]], p_mrmash_sec[[3]], p_mrmash_sec[[4]], p_mrmash_sec[[5]],
          p_mrmash_sec[[6]], p_mrmash_sec[[7]], p_mrmash_sec[[8]], p_mrmash_sec[[9]], NULL, 
          p_mrmash_sec[[10]], NULL,
          ncol = 3)
```

### *mr.mash* first pass vs elastic net

```{r mr.mash first vs enet, message=FALSE, fig.height=15, fig.width=15}
plot_grid(p_enet[[1]], p_enet[[2]], p_enet[[3]], p_enet[[4]], p_enet[[5]],
          p_enet[[6]], p_enet[[7]], p_enet[[8]], p_enet[[9]], NULL,
          p_enet[[10]], NULL,
          ncol = 3)
```

### *mr.mash* first pass vs sparse multi-task LASSO

```{r mr.mash first vs mtlasso, message=FALSE, fig.height=15, fig.width=15}
plot_grid(p_mtlasso[[1]], p_mtlasso[[2]], p_mtlasso[[3]], p_mtlasso[[4]], p_mtlasso[[5]],
          p_mtlasso[[6]], p_mtlasso[[7]], p_mtlasso[[8]], p_mtlasso[[9]], NULL,
          p_mtlasso[[10]], NULL,
          ncol = 3)
```
