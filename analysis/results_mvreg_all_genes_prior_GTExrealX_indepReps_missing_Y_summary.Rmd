---
title: "Summary of simulations with missing values in Y"
author: "Fabio Morgante"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r set opts, message=FALSE}
###Set options
options(stringsAsFactors=FALSE)

###Load libraries
library(dscrutils)
library(dplyr)
library(knitr)

###Function to convert dscquery output from list to data.frame suitable for plotting
convert_dsc_to_dataframe_gtex <- function(dsc){ ##add repli argument if wanting to have subrep rolling over from rep to rep
  ###Data.frame to store the results after convertion
  dsc_df <- data.frame()

  ###Get length of list elements
  n_elem <- length(dsc$DSC)

  ###Loop through the dsc list
  for(i in 1:n_elem){
    ##Prepare vectors making up the final data frame
    r_scalar <- dsc$simulate.r[i]
    p_causal <- rep(dsc$simulate.p_causal[i], times=r_scalar)
    r <- rep(dsc$simulate.r[i], times=r_scalar)
    response <- 1:r_scalar
    pve <- rep(dsc$simulate.pve[i], times=r_scalar)
    simulate <- rep(dsc$simulate[i], times=r_scalar)
    fit <- rep(dsc$fit[i], times=r_scalar)
    score <- rep(dsc$score[i], times=r_scalar)
    score.err <- dsc$score.err[[i]]
    timing <- rep(dsc$fit.time[i], times=r_scalar)

    ##Build the data frame
    df <- data.frame(p_num_caus=p_causal, r=r, response=response, pve=pve,
                     scenario=simulate, method=fit, score_metric=score, score_value=score.err, time=timing)
    dsc_df <- rbind(dsc_df, df)
  }

  ###Get number of genes
  n_methods <- length(unique(dsc$fit))
  n_metrics <- length(unique(dsc$score))
  n_genes <- n_elem/n_methods/n_metrics

  ###Compute replicates
  # beginning <- (repli*n_genes)-(n_genes-1)
  # ending <- repli*n_genes
  beginning <- 1
  ending <- n_genes
  reptot <- rep(rep(beginning:ending, each=dsc$simulate.r[1]), n_methods*n_metrics)

  dsc_df <- data.frame(subrep=reptot, dsc_df)

  return(dsc_df)
}

```
We will now summarize the scaled RMSE from the following scenarios:

+ [Shared effects](results_mvreg_all_genes_prior_GTExrealX_indepV_sharedB_r10_indepReps_missing_Y.html)
+ [Independent effects](results_mvreg_all_genes_prior_GTExrealX_indepV_indepB_r10_indepReps_missing_Y.html)
+ [Two blocks of responses (shared effects within block)](results_mvreg_all_genes_prior_GTExrealX_indepV_sharedB_2blocksr10_indepReps_missing_Y.html)
+ [Three causal responses (with shared effects) out of ten](results_mvreg_all_genes_prior_GTExrealX_indepV_sharedB_3causalrespr10_indepReps_missing_Y.html)
+ [One causal response out of ten](results_mvreg_all_genes_prior_GTExrealX_indepV_B_1causalrespr10_indepReps_missing_Y.html)


### Shared effects across conditions

```{r equal effects simulations, message=FALSE}
for(repl in 1:20){
  ###Load the dsc results
  dsc_out <- dscquery(paste0("output/tmp/mvreg_all_genes_prior_GTExrealX_indepV_sharedB_r10_indepReps_missing_Y/rep", repl), 
                      c("simulate.p_causal", "simulate.r", "simulate.r_causal", "simulate.pve", "simulate.B_cor", "simulate.w", 
                        "simulate.B_scale", "simulate.V_cor", "simulate", "fit", "score", "score.err", "fit.time"), 
                      groups="fit: mr_mash_em_can_enet, mr_mash_em_can_mlasso, mr_mash_em_data_mlasso, mr_mash_em_dataAndcan_mlasso, mr_mash_em_dataAndcan_dropcomp_mlasso, mtlasso, enet",
		      verbose=FALSE)
  
  ###Convert from list to data.frame for plotting
  if(repl==1){
    dsc_plots <- convert_dsc_to_dataframe_gtex(dsc_out)
    dsc_plots <- cbind(rep=repl, dsc_plots)
  } else if(repl>1){
    tmp <- convert_dsc_to_dataframe_gtex(dsc_out)
    tmp <- cbind(rep=repl, tmp)
    dsc_plots <- rbind(dsc_plots, tmp)
  }
}

rm(dsc_out)

###Compute summary stats by scenario and method
summ_shared <- dsc_plots %>%
                group_by(pve, p_num_caus, r, #response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()
```

### Independent effects across conditions

```{r independent effects simulations, message=FALSE}
for(repl in 1:20){
  ###Load the dsc results
  dsc_out <- dscquery(paste0("output/tmp/mvreg_all_genes_prior_GTExrealX_indepV_indepB_r10_indepReps_missing_Y/rep", repl),
                      c("simulate.p_causal", "simulate.r", "simulate.r_causal", "simulate.pve", "simulate.B_cor", "simulate.w",
                        "simulate.B_scale", "simulate.V_cor", "simulate", "fit", "score", "score.err", "fit.time"),
                      groups="fit: mr_mash_em_can_enet, mr_mash_em_can_mlasso, mr_mash_em_data_mlasso, mr_mash_em_dataAndcan_mlasso, mr_mash_em_dataAndcan_dropcomp_mlasso, mtlasso, enet",
                      verbose=FALSE)

  ###Convert from list to data.frame for plotting
  if(repl==1){
    dsc_plots <- convert_dsc_to_dataframe_gtex(dsc_out)
    dsc_plots <- cbind(rep=repl, dsc_plots)
  } else if(repl>1){
    tmp <- convert_dsc_to_dataframe_gtex(dsc_out)
    tmp <- cbind(rep=repl, tmp)
    dsc_plots <- rbind(dsc_plots, tmp)
  }
}

rm(dsc_out)

###Compute summary stats by scenario and method
summ_indep <- dsc_plots %>%
                group_by(pve, p_num_caus, r, #response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()
```

### Effects only in condition 1

```{r singleton effects simulations, message=FALSE}
for(repl in 1:20){
  ###Load the dsc results
  dsc_out <- dscquery(paste0("output/tmp/mvreg_all_genes_prior_GTExrealX_indepV_B_1causalrespr10_indepReps_missing_Y/rep", repl),
                      c("simulate.p_causal", "simulate.r", "simulate.r_causal", "simulate.pve", "simulate.B_cor", "simulate.w",
                        "simulate.B_scale", "simulate.V_cor", "simulate", "fit", "score", "score.err", "fit.time"),
                      groups="fit: mr_mash_em_can_enet, mr_mash_em_can_mlasso, mr_mash_em_data_mlasso, mr_mash_em_dataAndcan_mlasso, mr_mash_em_dataAndcan_dropcomp_mlasso, mtlasso, enet",
                      verbose=FALSE)

  ###Convert from list to data.frame for plotting
  if(repl==1){
    dsc_plots <- convert_dsc_to_dataframe_gtex(dsc_out)
    dsc_plots <- cbind(rep=repl, dsc_plots)
  } else if(repl>1){
    tmp <- convert_dsc_to_dataframe_gtex(dsc_out)
    tmp <- cbind(rep=repl, tmp)
    dsc_plots <- rbind(dsc_plots, tmp)
  }
}

rm(dsc_out)

###Compute summary stats by scenario and method
summ_singleton <- dsc_plots %>%
                group_by(pve, p_num_caus, r, #response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()

summ_singleton_resp <- dsc_plots %>%
                group_by(pve, p_num_caus, r, response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()
```

### Equal effects in condition 1-3

```{r one block effects simulations, message=FALSE}
for(repl in 1:20){
  ###Load the dsc results
  dsc_out <- dscquery(paste0("output/tmp/mvreg_all_genes_prior_GTExrealX_indepV_sharedB_3causalrespr10_indepReps_missing_Y/rep", repl),
                      c("simulate.p_causal", "simulate.r", "simulate.r_causal", "simulate.pve", "simulate.B_cor", "simulate.w",
                        "simulate.B_scale", "simulate.V_cor", "simulate", "fit", "score", "score.err", "fit.time"),
                      groups="fit: mr_mash_em_can_enet, mr_mash_em_can_mlasso, mr_mash_em_data_mlasso, mr_mash_em_dataAndcan_mlasso, mr_mash_em_dataAndcan_dropcomp_mlasso, mtlasso, enet",
                      verbose=FALSE)

  ###Convert from list to data.frame for plotting
  if(repl==1){
    dsc_plots <- convert_dsc_to_dataframe_gtex(dsc_out)
    dsc_plots <- cbind(rep=repl, dsc_plots)
  } else if(repl>1){
    tmp <- convert_dsc_to_dataframe_gtex(dsc_out)
    tmp <- cbind(rep=repl, tmp)
    dsc_plots <- rbind(dsc_plots, tmp)
  }
}

rm(dsc_out)

###Compute summary stats by scenario and method
summ_3shared <- dsc_plots %>%
                group_by(pve, p_num_caus, r, #response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()

summ_3shared_resp <- dsc_plots %>%
                group_by(pve, p_num_caus, r, response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()
```

### Shared effects in condition 1-3, shared effects in condition 7-10 (with per-condition PVE=0.05), and no sharing between these two groups

```{r two blocks effects simulations, message=FALSE}
for(repl in 1:20){
  ###Load the dsc results
  dsc_out <- dscquery(paste0("output/tmp/mvreg_all_genes_prior_GTExrealX_indepV_sharedB_2blocksr10_diffPVE_indepReps_missing_Y/rep", repl),
                      c("simulate.p_causal", "simulate.r", "simulate.r_causal", "simulate.pve", "simulate.B_cor", "simulate.w",
                        "simulate.B_scale", "simulate.V_cor", "simulate", "fit", "score", "score.err", "fit.time"),
                      groups="fit: mr_mash_em_can_enet, mr_mash_em_can_mlasso, mr_mash_em_data_mlasso, mr_mash_em_dataAndcan_mlasso, mr_mash_em_dataAndcan_dropcomp_mlasso, mtlasso, enet",
                      verbose=FALSE)

  ###Convert from list to data.frame for plotting
  if(repl==1){
    dsc_plots <- convert_dsc_to_dataframe_gtex(dsc_out)
    dsc_plots <- cbind(rep=repl, dsc_plots)
  } else if(repl>1){
    tmp <- convert_dsc_to_dataframe_gtex(dsc_out)
    tmp <- cbind(rep=repl, tmp)
    dsc_plots <- rbind(dsc_plots, tmp)
  }
}

rm(dsc_out)

###Compute summary stats by scenario and method
summ_2blocks <- dsc_plots %>%
                group_by(pve, p_num_caus, r, #response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()

summ_2blocks_resp <- dsc_plots %>%
                group_by(pve, p_num_caus, r, response,
                         scenario, method, score_metric) %>%
                  summarise_at(vars(score_value), list(mean=mean, sd=sd, n=length)) %>%
                    ungroup() %>%
                      as.data.frame()
```


```{r table, message=FALSE}
dat <- rbind(summ_shared, summ_indep, summ_singleton, summ_3shared, summ_2blocks)
dat$scenario <- rep(c("equal", "independent", "singleton", "shared_1to3", "two_blocks"), each=7)
kable(dat[which(dat$method != "mr_mash_em_dataAndcan_dropcomp_mlasso"), 4:9])

dat_resp <- rbind(summ_singleton_resp, summ_3shared_resp, summ_2blocks_resp)
dat_resp$scenario <- rep(c("singleton", "shared_1to3", "two_blocks"), each=7*10)
kable(dat_resp[which(dat_resp$method != "mr_mash_em_dataAndcan_dropcomp_mlasso"), 4:10])
```







